# circular-dependency-scanner å­¦ä¹ æ–‡æ¡£

> å¼€ç®±å³ç”¨çš„å¾ªç¯ä¾èµ–æ£€æµ‹å·¥å…·ï¼šæ”¯æŒ js/ts/vueï¼Œå‘½ä»¤è¡Œä¸ API åŒæ¨¡å¼

## ğŸ“š ç›®å½•

1. [ç”¨å¤§ç™½è¯è¯´ï¼šcircular-dependency-scanner æ˜¯å•¥](#ç”¨å¤§ç™½è¯è¯´circular-dependency-scanner-æ˜¯å•¥)
2. [åŸç†ï¼šæ•´ä½“æµç¨‹ä¸å®ç°æ€è·¯](#åŸç†æ•´ä½“æµç¨‹ä¸å®ç°æ€è·¯)
3. [å®‰è£…ä¸ä½¿ç”¨æ–¹å¼](#å®‰è£…ä¸ä½¿ç”¨æ–¹å¼)
4. [å‘½ä»¤è¡Œï¼šds ä¸é€‰é¡¹](#å‘½ä»¤è¡Œds-ä¸é€‰é¡¹)
5. [JavaScript API](#javascript-api)
6. [è¯†åˆ«å“ªäº›å¼•ç”¨ã€åˆ«åä¸ç±»å‹](#è¯†åˆ«å“ªäº›å¼•ç”¨åˆ«åä¸ç±»å‹)
7. [Monorepo ä¸å¤šé¡¹ç›®](#monorepo-ä¸å¤šé¡¹ç›®)
8. [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
9. [å¸¸è§å‘ä¸æœ€ä½³å®è·µ](#å¸¸è§å‘ä¸æœ€ä½³å®è·µ)
10. [ç›¸å…³å·¥å…·ä¸å‚è€ƒ](#ç›¸å…³å·¥å…·ä¸å‚è€ƒ)

---

## ç”¨å¤§ç™½è¯è¯´ï¼šcircular-dependency-scanner æ˜¯å•¥

### ä½ é‡åˆ°çš„é—®é¢˜ï¼ˆå¾ªç¯ä¾èµ–æ—¶ï¼‰

- **A å¼• Bï¼ŒB åˆå¼• A**ï¼šæ¨¡å—é—´å½¢æˆç¯ï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶æœªå®šä¹‰ã€æ‰“åŒ…é¡ºåºå¼‚å¸¸ã€æ ‘æ‘‡å¤±æ•ˆã€‚
- **éš¾å‘ç°**ï¼šé äººçœ‹ import é“¾å¾ˆéš¾ï¼Œå°¤å…¶é¡¹ç›®å¤§äº†ä»¥åã€‚
- **ç°æœ‰å·¥å…·ä¸çˆ½**ï¼šæœ‰çš„åªåš Webpack/Rollup/Vite æ’ä»¶ã€ä¾èµ–æ„å»ºå›¾ï¼Œæœ‰çš„æ¼æ£€ã€æ…¢ã€éš¾å•ç‹¬è·‘ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š**ç‹¬ç«‹ã€å¿«é€Ÿã€å‡†ç¡®**åœ°æ‰«å‡ºã€Œè°å’Œè°å½¢æˆç¯ã€ï¼Œå°±æ˜¯ circular-dependency-scanner è¦è§£å†³çš„ã€‚

### circular-dependency-scanner å¸®ä½ åšå•¥

**circular-dependency-scanner** æ˜¯ **å¾ªç¯ä¾èµ–æ£€æµ‹å·¥å…·**ï¼š

1. **ç‹¬ç«‹è¿è¡Œ**ï¼šä¸ä¾èµ– Webpack/Viteï¼Œç›´æ¥è§£ææºç é‡Œçš„ import/require/exportï¼Œå»ºä¾èµ–å›¾å†ç®—ç¯ã€‚
2. **å¤šæ ¼å¼æ”¯æŒ**ï¼š.jsã€.jsxã€.tsã€.tsxã€.mjsã€.cjsã€.vue éƒ½èƒ½æ‰«ã€‚
3. **è·¯å¾„åˆ«å**ï¼šé€šè¿‡ tsconfig/jsconfig çš„ `compilerOptions.paths` è§£æåˆ«åï¼Œè¿˜åŸæˆå®é™…è·¯å¾„å†ç®—ç¯ã€‚
4. **åŒæ¨¡å¼**ï¼š**å‘½ä»¤è¡Œ** `ds` å’Œ **JavaScript API** `circularDepsDetect()`ï¼Œé€‚åˆ CI æˆ–è„šæœ¬é›†æˆã€‚
5. **å¯é€‰æ’é™¤çº¯ç±»å‹å¼•ç”¨**ï¼š`import type`ã€`export type` å¯ä¸å‚ä¸ç¯è®¡ç®—ï¼Œå‡å°‘è¯¯æŠ¥ã€‚

ä¸€å¥è¯ï¼š**circular-dependency-scanner = æ‰«æºç  â†’ å»ºä¾èµ–å›¾ â†’ è¾“å‡ºæ‰€æœ‰ç¯**ï¼Œå‘½ä»¤è¡Œå’Œ API éƒ½èƒ½ç”¨ã€‚

---

## åŸç†ï¼šæ•´ä½“æµç¨‹ä¸å®ç°æ€è·¯

circular-dependency-scanner çš„æ ¸å¿ƒå¯ä»¥æ¦‚æ‹¬ä¸ºï¼š**ä»æºç é‡ŒæŠ½å‡ºã€Œè°ä¾èµ–è°ã€â†’ å»ºæˆæœ‰å‘å›¾ â†’ ç”¨å›¾è®ºç®—æ³•æ‰¾å‡ºæ‰€æœ‰ç¯**ã€‚ä¸‹é¢æŒ‰æ­¥éª¤è¯´æ˜ã€‚

### 1. æ•´ä½“æµç¨‹ï¼ˆäº”æ­¥ï¼‰

```text
â‘  æ”¶é›†æ–‡ä»¶ â†’ â‘¡ ä»æ¯ä¸ªæ–‡ä»¶æå–ä¾èµ–è·¯å¾„ â†’ â‘¢ è·¯å¾„è§£æï¼ˆåˆ«åâ†’å®é™…è·¯å¾„ï¼‰â†’ â‘£ å»ºä¾èµ–å›¾ â†’ â‘¤ æ‰¾ç¯å¹¶è¾“å‡º
```

- **â‘  æ”¶é›†æ–‡ä»¶**ï¼šåœ¨æŒ‡å®šç›®å½•ä¸‹æŒ‰ glob æ”¶é›†è¦æ‰«æçš„æ–‡ä»¶ï¼ˆ.jsã€.jsxã€.tsã€.tsxã€.mjsã€.cjsã€.vueï¼‰ï¼Œå¹¶æ’é™¤ `ignore` é…ç½®çš„è·¯å¾„ï¼ˆå¦‚ node_modulesã€distï¼‰ã€‚
- **â‘¡ æå–ä¾èµ–è·¯å¾„**ï¼šå¯¹æ¯ä¸ªæ–‡ä»¶çš„æºç åšè§£æï¼Œæ‰¾å‡ºæ‰€æœ‰ã€ŒæŒ‡å‘å…¶ä»–æ¨¡å—ã€çš„å¼•ç”¨ï¼Œå³ï¼š
  - `import ... from 'path'`ã€`import('path')`ã€`require('path')`
  - `export * from 'path'`ã€`export { x } from 'path'` ç­‰  
  å¾—åˆ°çš„æ˜¯**å­—ç¬¦ä¸²å½¢å¼çš„è·¯å¾„**ï¼ˆç›¸å¯¹è·¯å¾„æˆ–åˆ«åï¼‰ï¼Œä¸”å¯é€‰åœ°**æ’é™¤çº¯ç±»å‹å¼•ç”¨**ï¼ˆ`import type`ã€`export type` ç­‰ï¼‰ï¼Œä¸å‚ä¸åç»­å»ºå›¾ã€‚
- **â‘¢ è·¯å¾„è§£æ**ï¼šæŠŠã€Œç›¸å¯¹è·¯å¾„ã€å’Œã€Œåˆ«åã€è½¬æˆ**å”¯ä¸€ã€å¯æ¯”è¾ƒçš„ç»å¯¹è·¯å¾„**ï¼ˆæˆ–é¡¹ç›®å†…ç›¸å¯¹è·¯å¾„ï¼‰ã€‚åˆ«åè§£æä¾èµ– **get-tsconfig** è¯»å–æœ€è¿‘ tsconfig/jsconfig çš„ `compilerOptions.paths` å’Œ `baseUrl`ï¼ŒæœªçŸ¥åˆ«åä¼šè¢«å¿½ç•¥ã€‚
- **â‘£ å»ºä¾èµ–å›¾**ï¼šæ„é€ ä¸€å¼ **æœ‰å‘å›¾**ï¼š  
  - **èŠ‚ç‚¹**ï¼šæ¯ä¸ªè¢«å¼•ç”¨åˆ°çš„æ–‡ä»¶ï¼ˆä¸€ä¸ªè·¯å¾„ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ã€‚  
  - **è¾¹**ï¼šè‹¥æ–‡ä»¶ A çš„æºç é‡Œå‡ºç°äº†å¯¹æ–‡ä»¶ B çš„å¼•ç”¨ï¼Œåˆ™æœ‰ä¸€æ¡è¾¹ **A â†’ B**ã€‚  
  è¿™æ ·ã€ŒA ä¾èµ– Bï¼ŒB åˆä¾èµ– Aã€å°±ä¼šå½¢æˆå›¾é‡Œçš„ä¸€ä¸ª**ç¯**ã€‚
- **â‘¤ æ‰¾ç¯å¹¶è¾“å‡º**ï¼šåœ¨ä¾èµ–å›¾ä¸Šè¿è¡Œ**ç¯æ£€æµ‹ç®—æ³•**ï¼Œæ‰¾å‡ºæ‰€æœ‰ç¯ï¼ˆæˆ–æ‰€æœ‰åœ¨ç¯ä¸Šçš„è¾¹/èŠ‚ç‚¹ï¼‰ï¼Œå†æŒ‰ `filter` ç­‰é€‰é¡¹è¿‡æ»¤ï¼Œè¾“å‡ºåˆ°æ§åˆ¶å°æˆ–æ–‡ä»¶ã€‚å®˜æ–¹å®ç°é‡Œç¯æ£€æµ‹åŸºäº **graph-cycles**ï¼ˆRust åº“ï¼‰ï¼Œæœ¬è´¨æ˜¯åœ¨æœ‰å‘å›¾ä¸Šæ‰¾**å¼ºè¿é€šåˆ†é‡**æˆ–ç­‰ä»·æ„ä¹‰ä¸Šçš„ã€Œç¯ã€ã€‚

### 2. ä¸ºä»€ä¹ˆæ˜¯ã€Œæœ‰å‘å›¾ + ç¯ã€

- **æœ‰å‘å›¾**ï¼šä¾èµ–å…³ç³»æ˜¯å•å‘çš„â€”â€”ã€ŒA å¼•ç”¨ Bã€ä¸ç­‰äºã€ŒB å¼•ç”¨ Aã€ï¼Œæ‰€ä»¥ç”¨æœ‰å‘è¾¹è¡¨ç¤ºã€‚
- **ç¯**ï¼šè‹¥å­˜åœ¨ä¸€ç»„èŠ‚ç‚¹ vâ‚ â†’ vâ‚‚ â†’ â€¦ â†’ vâ‚– â†’ vâ‚ï¼Œåˆ™è¯´æ˜è¿™ç»„æ¨¡å—**äº’ç›¸ä¾èµ–**ï¼Œå³å¾ªç¯ä¾èµ–ã€‚ç¯å¯èƒ½å¾ˆé•¿ï¼ˆAâ†’Bâ†’Câ†’â€¦â†’Aï¼‰ï¼Œä¸ä¸€å®šåªæ˜¯ä¸¤ä¸¤äº’æŒ‡ã€‚
- **å¼ºè¿é€šåˆ†é‡ï¼ˆSCCï¼‰**ï¼šæœ‰å‘å›¾ä¸­ã€Œä»»æ„ä¸¤ç‚¹éƒ½äº’ç›¸å¯è¾¾ã€çš„æå¤§å­å›¾ã€‚æ¯ä¸ª**éå•ç‚¹çš„å¼ºè¿é€šåˆ†é‡**é‡Œéƒ½è‡³å°‘åŒ…å«ä¸€ä¸ªç¯ï¼Œæ‰€ä»¥æ‰¾ç¯å¸¸ç”¨ Tarjan ç­‰ç®—æ³•å…ˆæ±‚å‡ºæ‰€æœ‰ SCCï¼Œå†åœ¨ SCC å†…æ‰¾å…·ä½“ç¯è·¯å¾„ï¼›**graph-cycles** åšçš„å°±æ˜¯è¿™ç±»å›¾è®ºè®¡ç®—ã€‚

### 3. å„ç¯èŠ‚åœ¨å®ç°ä¸Šçš„è¦ç‚¹

| ç¯èŠ‚ | å®ç°è¦ç‚¹ |
|------|----------|
| **æ”¶é›†æ–‡ä»¶** | æŒ‰æ‰©å±•å + ignore åˆ—è¡¨åš globï¼Œä¸ä¾èµ–æ‰“åŒ…å·¥å…·ã€‚ |
| **æå–å¼•ç”¨** | éœ€æ­£ç¡®è¯†åˆ« import/require/export from çš„è¯­æ³•ï¼ˆå«åŠ¨æ€ importã€å¤šè¡Œç­‰ï¼‰ï¼Œä¸€èˆ¬ç”¨ **AST è§£æ**ï¼ˆå¦‚ TypeScript ç¼–è¯‘å™¨ API æˆ– Babelï¼‰æˆ–æ­£åˆ™ï¼›çº¯ç±»å‹å¼•ç”¨é€šè¿‡ AST åˆ¤æ–­æ˜¯å¦å¸¦ `type` å…³é”®å­—ã€‚ |
| **è·¯å¾„è§£æ** | ç›¸å¯¹è·¯å¾„ + baseUrl â†’ ç»å¯¹è·¯å¾„ï¼›åˆ«å â†’ ç”¨ get-tsconfig è§£æ paths å¾—åˆ°å®é™…è·¯å¾„ã€‚åŒä¸€ç‰©ç†æ–‡ä»¶å¯èƒ½è¢«ä¸åŒè·¯å¾„å¼•ç”¨ï¼ˆå¦‚ `@/foo` ä¸ `src/foo`ï¼‰ï¼Œéœ€ç»Ÿä¸€æˆåŒä¸€èŠ‚ç‚¹ã€‚ |
| **å»ºå›¾** | èŠ‚ç‚¹ = æ–‡ä»¶è·¯å¾„ï¼Œè¾¹ = ä¾èµ–å…³ç³»ï¼›åªä¿ç•™åœ¨ã€Œæ”¶é›†åˆ°çš„æ–‡ä»¶é›†åˆã€å†…çš„ç›®æ ‡ï¼Œé¿å…æŠŠ node_modules ç­‰ç®—è¿›å»ã€‚ |
| **æ‰¾ç¯** | ä½¿ç”¨å›¾è®ºç®—æ³•ï¼ˆå¦‚åŸºäº DFS çš„ Tarjan æ±‚ SCCï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦çº¦ä¸º O(èŠ‚ç‚¹æ•° + è¾¹æ•°)ï¼›graph-cycles æä¾›ç°æˆå®ç°ã€‚ |

### 4. å°ç»“ï¼ˆä¸€å¥è¯ç‰ˆï¼‰

- **åŸç†**ï¼šé€šè¿‡**è§£ææºç ä¸­çš„ import/require/export** å¾—åˆ°ä¾èµ–å…³ç³»ï¼Œ**ç”¨ tsconfig paths ç­‰è§£ææˆå®é™…æ–‡ä»¶è·¯å¾„**ï¼Œ**å»ºæœ‰å‘å›¾**ï¼Œå†ç”¨**å›¾è®ºä¸­çš„ç¯/å¼ºè¿é€šåˆ†é‡ç®—æ³•**æ‰¾å‡ºæ‰€æœ‰å¾ªç¯ä¾èµ–å¹¶è¾“å‡ºã€‚
- **å’Œæ‰“åŒ…æ’ä»¶çš„åŒºåˆ«**ï¼šä¸ä¾èµ– Webpack/Vite çš„æ¨¡å—å›¾ï¼Œç›´æ¥è¯»æºç å»ºå›¾ï¼Œæ‰€ä»¥å¯ä»¥**ç‹¬ç«‹è¿è¡Œ**ã€**ä¸å¯åŠ¨æ„å»º**ï¼Œä¸”èƒ½è¦†ç›–æœªè¢«æ‰“åŒ…è¿›å»çš„æºç ï¼›ä»£ä»·æ˜¯æ— æ³•åˆ©ç”¨æ‰“åŒ…æ—¶çš„æ¨¡å—è§£æï¼ˆå¦‚ resolve æ’ä»¶ï¼‰ï¼Œåˆ«åç­‰å®Œå…¨ä¾èµ– tsconfig/jsconfigã€‚

---

## å®‰è£…ä¸ä½¿ç”¨æ–¹å¼

### å®‰è£…

```bash
# å…¨å±€ï¼ˆç”¨å‘½ä»¤è¡Œ dsï¼‰
pnpm add -g circular-dependency-scanner
# æˆ–
npm i -g circular-dependency-scanner

# é¡¹ç›®å†…ï¼ˆç”¨ API æˆ– npx dsï¼‰
pnpm add -D circular-dependency-scanner
```

### å‘½ä»¤è¡Œï¼ˆæ¨èï¼‰

- å®‰è£…åæä¾› **`ds`**ï¼ˆdepscanï¼‰å‘½ä»¤ï¼š

```bash
ds              # æ‰«å½“å‰ç›®å½•
ds src          # æ‰« src ç›®å½•
ds -h            # å¸®åŠ©
ds -V            # ç‰ˆæœ¬
```

### JavaScript API

- åœ¨è„šæœ¬é‡Œè°ƒç”¨ **circularDepsDetect(options)**ï¼Œè¿”å›æ£€æµ‹ç»“æœï¼ˆç¯åˆ—è¡¨ç­‰ï¼‰ï¼Œè§ä¸‹èŠ‚ã€‚

---

## å‘½ä»¤è¡Œï¼šds ä¸é€‰é¡¹

### åŸºæœ¬ç”¨æ³•

```bash
ds [options] [path]
```

- **path**ï¼šè¦æ‰«æçš„ç›®å½•ï¼Œé»˜è®¤å½“å‰ç›®å½•ã€‚
- **options**ï¼šè§ä¸‹è¡¨ã€‚

### å¸¸ç”¨é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ |
|------|------|
| **-h, --help** | æ‰“å°å¸®åŠ©ã€‚ |
| **-V, --version** | æ‰“å°ç‰ˆæœ¬ã€‚ |
| **--filter &lt;pattern&gt;** | åªè¾“å‡ºåŒ¹é…è¯¥ glob çš„ç¯ï¼Œä¾‹å¦‚ `--filter 'src/router/*.ts'`ã€‚ |
| **--ignore &lt;path...&gt;** | å¿½ç•¥çš„è·¯å¾„ï¼ˆå¦‚ outputã€distã€node_modulesï¼‰ï¼Œå¯å¤šä¸ªã€‚ |
| **--output, -o &lt;file&gt;** | å°†ç»“æœå†™å…¥æ–‡ä»¶ï¼ˆå¦‚ circles.jsonï¼‰ï¼›ä¸å†™åˆ™æ‰“å°åˆ°æ§åˆ¶å°ã€‚ |
| **--throw** | å‘ç°ç¯æ—¶ä»¥é€€å‡ºç  1 é€€å‡ºï¼Œä¾¿äº CI å¤±è´¥ã€‚ |
| **--exclude-type** | æ’é™¤çº¯ç±»å‹å¼•ç”¨ï¼ˆimport type / export typeï¼‰ä¸å‚ä¸ç¯è®¡ç®—ã€‚ |
| **--absolute** | è¾“å‡ºç»å¯¹è·¯å¾„ã€‚ |

### ç¤ºä¾‹

```bash
ds                           # å½“å‰ç›®å½•ï¼Œç»“æœæ‰“å±
ds src                       # åªæ‰« src
ds --filter 'src/**/*.ts'    # åªæ˜¾ç¤ºæ¶‰åŠ src ä¸‹ .ts çš„ç¯
ds --ignore dist node_modules
ds -o circles.json           # ç»“æœå†™å…¥ circles.json
ds --throw                   # æœ‰ç¯åˆ™ exit 1ï¼ˆCI ç”¨ï¼‰
ds --exclude-type            # å¿½ç•¥çº¯ç±»å‹å¼•ç”¨
ds --absolute                # è¾“å‡ºç»å¯¹è·¯å¾„
```

- ä¸æŒ‡å®š `-o` æ—¶ï¼Œæ§åˆ¶å°ä¼šæŒ‰æ–‡ä»¶ç±»å‹ç€è‰²ï¼ˆå¦‚ ts è“ã€js é»„ã€vue ç»¿ï¼‰æ‰“å°ç¯è·¯å¾„ã€‚

---

## JavaScript API

### circularDepsDetect(options?)

åœ¨ä»£ç é‡Œè°ƒç”¨ï¼Œè¿”å›æ£€æµ‹ç»“æœï¼ˆç¯çš„æ•°ç»„ç­‰ï¼‰ã€‚

```javascript
import { circularDepsDetect } from 'circular-dependency-scanner';

const results = circularDepsDetect({
  cwd: process.cwd(),        // æ‰«ææ ¹ç›®å½•ï¼Œé»˜è®¤ process.cwd()
  absolute: false,           // æ˜¯å¦è¾“å‡ºç»å¯¹è·¯å¾„
  ignore: ['node_modules'],  // å¿½ç•¥çš„ globï¼Œé»˜è®¤å« node_modules
  filter: undefined,         // åªä¿ç•™åŒ¹é…è¯¥ glob çš„ç¯
  excludeTypes: false,       // æ˜¯å¦æ’é™¤çº¯ç±»å‹å¼•ç”¨
});
```

- **è¿”å›å€¼**ï¼šå…·ä½“ç»“æ„è§åŒ…ç±»å‹å®šä¹‰ï¼Œä¸€èˆ¬åŒ…å«ã€Œç¯ã€çš„åˆ—è¡¨ï¼ˆæ¯æ¡ç¯æ˜¯ä¸€ç»„æ–‡ä»¶è·¯å¾„ï¼‰ã€‚
- å¯ç”¨äºè„šæœ¬é‡Œæ ¹æ®ç»“æœæ‰“æ—¥å¿—ã€å†™æ–‡ä»¶ã€æˆ–å†³å®š process.exit(1)ã€‚

---

## è¯†åˆ«å“ªäº›å¼•ç”¨ã€åˆ«åä¸ç±»å‹

### ä¼šå‚ä¸ç¯è®¡ç®—çš„å¼•ç”¨

- **import**ï¼š`import x from './a'`ã€`import './a'`ã€`import * as x from './a'`
- **åŠ¨æ€ import**ï¼š`import('./a')`
- **require**ï¼š`require('./a')`
- **export from**ï¼š`export * from './a'`ã€`export { x } from './a'` ç­‰ï¼ˆä¼šè§£æ from çš„è·¯å¾„ï¼‰

**ä¸ä¼š**ä»ã€Œåª re-export æœ¬æ–‡ä»¶å·²æœ‰ç¬¦å·ã€çš„ `export { a }` é‡Œè§£æå‡ºè·¯å¾„ï¼ˆæ²¡æœ‰ fromï¼‰ã€‚

### è·¯å¾„åˆ«åï¼ˆtsconfig / jsconfigï¼‰

- ä½¿ç”¨ **get-tsconfig** è§£æ **compilerOptions.paths**ï¼ˆä»¥åŠ baseUrlï¼‰ï¼ŒæŠŠåˆ«åè½¬æˆå®é™…è·¯å¾„å†å»ºå›¾ã€‚
- éœ€åœ¨**æ‰«ææ ¹ç›®å½•æˆ–å…¶çˆ¶çº§**æœ‰ **tsconfig.json** æˆ– **jsconfig.json**ï¼Œä¸”é…ç½®å¥½ pathsï¼›**æœªçŸ¥åˆ«åä¼šè¢«å¿½ç•¥**ï¼Œå¯èƒ½å¯¼è‡´æ¼ç¯æˆ–è¯¯æŠ¥ï¼Œå»ºè®®ä¿è¯åˆ«åé…ç½®æ­£ç¡®ã€‚

### çº¯ç±»å‹å¼•ç”¨ï¼ˆ--exclude-type / excludeTypes: trueï¼‰

- **ä¸å‚ä¸ç¯è®¡ç®—**çš„å†™æ³•ç¤ºä¾‹ï¼š  
  `import type ...`ã€`export type ...`ã€`export type * from '...'`ã€`export { type a } from '...'` ç­‰ã€‚
- **ä»å‚ä¸ç¯è®¡ç®—**çš„ï¼šæ™®é€š `import`ã€`export * from`ã€`export * as x from`ã€`import { type a, b }`ï¼ˆæ··å…¥å€¼çš„ä¼šç®—ï¼‰ã€‚
- è‹¥é¡¹ç›®é‡Œå¤§é‡ã€Œä»…ç±»å‹ã€çš„è·¨æ–‡ä»¶å¼•ç”¨ï¼Œå¯å¼€ **--exclude-type** / **excludeTypes: true** å‡å°‘å™ªéŸ³ã€‚

---

## Monorepo ä¸å¤šé¡¹ç›®

- ä¾èµ–å›¾ä¾èµ–**å½“å‰æ‰«æç›®å½•ä¸‹çš„ tsconfig/jsconfig çš„ paths**ã€‚åœ¨ **Monorepo æ ¹ç›®å½•**æ‰§è¡Œæ—¶ï¼Œä¸åŒå­é¡¹ç›®å¯èƒ½å…±ç”¨åŒååˆ«åä½†æŒ‡å‘ä¸åŒè·¯å¾„ï¼Œå¯¼è‡´è§£ææ··ä¹±ã€ç»“æœä¸å¯é ã€‚
- **å»ºè®®**ï¼š**æŒ‰é¡¹ç›®/åŒ…åˆ†åˆ«æ‰«æ**ï¼Œåœ¨å„è‡ªåŒ…ç›®å½•ä¸‹æ‰§è¡Œ `ds` æˆ– `circularDepsDetect({ cwd: 'packages/a' })`ï¼Œè€Œä¸æ˜¯åœ¨æ ¹ç›®å½•ä¸€æ¬¡æ€§æ‰«æ•´ä¸ªä»“åº“ã€‚

---

## å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå‘½ä»¤è¡Œæ‰«å½“å‰ç›®å½•å¹¶å†™ JSON

```bash
pnpm add -D circular-dependency-scanner
pnpm exec ds --output circles.json --throw
```

- æœ‰ç¯æ—¶ `--throw` ä¼šè®©è¿›ç¨‹ exit 1ï¼Œä¾¿äº CI å¤±è´¥ã€‚

### ç¤ºä¾‹ 2ï¼šåœ¨è„šæœ¬é‡Œè°ƒç”¨ API

```javascript
import { circularDepsDetect } from 'circular-dependency-scanner';

const results = circularDepsDetect({
  cwd: 'src',
  ignore: ['node_modules', 'dist'],
  excludeTypes: true,
});

if (results.length > 0) {
  console.error('Found circular dependencies:', results);
  process.exit(1);
}
```

### ç¤ºä¾‹ 3ï¼špackage.json è„šæœ¬

```json
{
  "scripts": {
    "circular": "ds",
    "circular:ci": "ds --throw --exclude-type -o circles.json"
  }
}
```

---

## å¸¸è§å‘ä¸æœ€ä½³å®è·µ

1. **åˆ«åå¿…é¡»é…å¥½**ï¼špaths æœªé…æˆ–é…é”™ï¼Œåˆ«åä¼šè¢«å¿½ç•¥ï¼Œç¯å¯èƒ½æ¼æ£€æˆ–é”™æŠ¥ï¼›æ‰«æç›®å½•å†…è¦æœ‰æ­£ç¡®çš„ tsconfig/jsconfigã€‚
2. **Monorepo æŒ‰åŒ…æ‰«**ï¼šåœ¨æ ¹ç›®å½•æ‰«æ•´ä»“æ˜“é”™ï¼Œå»ºè®®è¿›æ¯ä¸ªåŒ…å†è·‘ `ds` æˆ– APIã€‚
3. **ç±»å‹å¼•ç”¨**ï¼šè‹¥å¤§é‡ `import type` å¯¼è‡´è¯¯æŠ¥ç¯ï¼Œå¯å¼€ `--exclude-type` / `excludeTypes: true`ã€‚
4. **CI å¤±è´¥**ï¼šç”¨ `ds --throw` æˆ–åœ¨ API é‡Œæ ¹æ®ç»“æœ `process.exit(1)`ã€‚
5. **è¿‡æ»¤ä¸å¿½ç•¥**ï¼šç”¨ `--filter` åªå…³å¿ƒæŸå—ä»£ç çš„ç¯ï¼›ç”¨ `--ignore` æ’é™¤ build äº§ç‰©ã€node_modules ç­‰ã€‚
6. **è¾“å‡º**ï¼šéœ€è¦åç»­å¤„ç†æ—¶ç”¨ `-o circles.json`ï¼›ä»…çœ‹ç»“æœå¯ä¸ç”¨ `-o`ï¼Œç›´æ¥çœ‹æ§åˆ¶å°ã€‚

---

## ç›¸å…³å·¥å…·ä¸å‚è€ƒ

### ç›¸å…³å·¥å…·

| å·¥å…· | è¯´æ˜ |
|------|------|
| **circular-dependency-plugin** | Webpack æ’ä»¶ï¼Œåœ¨æ„å»ºæ—¶æ£€æµ‹ç¯ã€‚ |
| **vite-plugin-circular-dependency** | Vite æ’ä»¶ï¼Œå¯è¾“å‡º HTML æŠ¥å‘Šã€‚ |
| **detect-circular-deps** | ä¾§é‡ã€Œä¼šå¯¼è‡´é—®é¢˜çš„ã€ç¯ç±»å‹ã€‚ |

- éœ€è¦**ç‹¬ç«‹äºæ„å»º**ã€**å¤šæ ¼å¼**ã€**CLI + API** æ—¶ï¼Œcircular-dependency-scanner æ›´åˆé€‚ã€‚

### å‚è€ƒä¸å»¶ä¼¸é˜…è¯»

- [circular-dependency-scanner GitHub](https://github.com/emosheeep/circular-dependency-scanner)
- [circular-dependency-scanner npm](https://www.npmjs.com/package/circular-dependency-scanner)
- [get-tsconfig](https://github.com/privatenumber/get-tsconfig)ï¼ˆè·¯å¾„è§£æï¼‰
- æœ¬ä»“åº“ [33_manypkg_get_packages](../33_manypkg_get_packages/)ï¼šè‹¥éœ€åœ¨ monorepo é‡ŒæŒ‰åŒ…æ‰¹é‡è·‘ï¼Œå¯ç»“åˆè„šæœ¬éå†åŒ…å†è°ƒ `circularDepsDetect`ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šé’ˆå¯¹ circular-dependency-scanner å½“å‰ CLI ä¸ API æ•´ç†ï¼›å…·ä½“ä»¥å®˜æ–¹ä»“åº“ä¸ npm ä¸ºå‡†ã€‚

# h3 å­¦ä¹ æ–‡æ¡£

> è½»é‡ã€å¯ç»„åˆçš„ HTTP æœåŠ¡æ¡†æ¶ï¼Œé¢å‘ç°ä»£ JavaScript æ—¶ä»£ï¼›æ”¯æŒ Node.jsã€Bunã€Denoã€Workers ç­‰å¤šè¿è¡Œæ—¶ï¼ŒNuxt/Nitro ç­‰åº•å±‚ä½¿ç”¨

## ğŸ“š ç›®å½•

1. [ç”¨å¤§ç™½è¯è¯´ï¼šh3 æ˜¯å•¥](#ç”¨å¤§ç™½è¯è¯´h3-æ˜¯å•¥)
2. [åŸç†ï¼šä¸ºä»€ä¹ˆè½»é‡ã€å¯ç»„åˆã€è·¨è¿è¡Œæ—¶](#åŸç†ä¸ºä»€ä¹ˆè½»é‡å¯ç»„åˆè·¨è¿è¡Œæ—¶)
3. [ä¸ Expressã€Fastify çš„å¯¹æ¯”](#ä¸-expressfastify-çš„å¯¹æ¯”)
4. [å®‰è£…ä¸ä½¿ç”¨æ–¹å¼](#å®‰è£…ä¸ä½¿ç”¨æ–¹å¼)
5. [App å®ä¾‹ä¸å…¨å±€é’©å­](#app-å®ä¾‹ä¸å…¨å±€é’©å­)
6. [äº‹ä»¶å¤„ç†å™¨ä¸å“åº”ç±»å‹](#äº‹ä»¶å¤„ç†å™¨ä¸å“åº”ç±»å‹)
7. [è·¯ç”±ï¼šRouter ä¸ radix3](#è·¯ç”±router-ä¸-radix3)
8. [Event å¯¹è±¡ä¸è¯·æ±‚å·¥å…·](#event-å¯¹è±¡ä¸è¯·æ±‚å·¥å…·)
9. [é€‚é…å™¨ï¼šNode / Web / å…¶ä»–è¿è¡Œæ—¶](#é€‚é…å™¨node--web--å…¶ä»–è¿è¡Œæ—¶)
10. [å¸¸è§åœºæ™¯ä¸æœ€ä½³å®è·µ](#å¸¸è§åœºæ™¯ä¸æœ€ä½³å®è·µ)
11. [å‚è€ƒä¸å»¶ä¼¸é˜…è¯»](#å‚è€ƒä¸å»¶ä¼¸é˜…è¯»)

---

## ç”¨å¤§ç™½è¯è¯´ï¼šh3 æ˜¯å•¥

### ä½ é‡åˆ°çš„é—®é¢˜ï¼ˆå†™ HTTP æœåŠ¡æ—¶ï¼‰

- **æ¡†æ¶å¤ªé‡**ï¼šExpress ç”Ÿæ€å¤§ä½†è®¾è®¡è€ã€ä¸­é—´ä»¶å †å å¤šï¼Œæƒ³å†™ä¸€ä¸ªå° API ä¹Ÿè¦ä¸€å † `app.use`ã€‚
- **ç»‘å®šè¿è¡Œæ—¶**ï¼šä»£ç å†™æ­» Node çš„ `req/res`ï¼Œæ¢åˆ° Denoã€Cloudflare Workers å°±è¦é‡å†™ã€‚
- **ç±»å‹ä¸å‹å¥½**ï¼šè¯·æ±‚/å“åº”ã€è·¯ç”±å‚æ•°ç»å¸¸è¦æ‰‹å†™ç±»å‹ï¼Œå®¹æ˜“å‡ºé”™ã€‚
- **åªæƒ³ã€Œæ”¶è¯·æ±‚ã€åšé€»è¾‘ã€è¿”ç»“æœã€**ï¼šä¸éœ€è¦å¤§è€Œå…¨çš„ã€Œä¼ä¸šçº§æ¡†æ¶ã€ï¼Œä½†è¦æ¸…æ™°ã€å¿«ã€å¥½ç»´æŠ¤ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š**åœ¨ã€Œæ”¶ HTTP è¯·æ±‚ã€è·‘ä¸šåŠ¡é€»è¾‘ã€è¿”å›å“åº”ã€è¿™ä»¶äº‹ä¸Šï¼Œåšåˆ°è½»é‡ã€å¯ç»„åˆã€è·¨è¿è¡Œæ—¶ã€ç±»å‹å‹å¥½**ï¼Œå°±æ˜¯ h3 è¦è§£å†³çš„é—®é¢˜ã€‚

### h3 å¸®ä½ åšå•¥

**h3**ï¼ˆHTTP çš„ç¼©å†™ï¼Œè¯»ä½œ /eÉªtÊƒÎ¸riË/ï¼Œå³ h-3ï¼‰æ˜¯ [UnJS](https://unjs.io/) ç”Ÿæ€ä¸‹çš„ **è½»é‡ã€å¯ç»„åˆ HTTP æœåŠ¡æ¡†æ¶**ï¼š

1. **è·¨è¿è¡Œæ—¶**ï¼šåŒä¸€å¥— h3 åº”ç”¨å¯é€šè¿‡ **é€‚é…å™¨ï¼ˆAdapterï¼‰** è·‘åœ¨ Node.jsã€Bunã€Denoã€Cloudflare Workers ç­‰ç¯å¢ƒï¼Œä¸ç»‘æ­»æŸä¸€è¿è¡Œæ—¶ã€‚
2. **å¯ç»„åˆ**ï¼šæ ¸å¿ƒåªæœ‰ä¸€ä¸ªã€ŒApp å®ä¾‹ã€+ã€Œäº‹ä»¶å¤„ç†å™¨æ ˆã€ï¼›åŠŸèƒ½é€šè¿‡ **å·¥å…·å‡½æ•°ï¼ˆUtilsï¼‰** æŒ‰éœ€å¼•å…¥ï¼ˆå¦‚ `getQuery`ã€`readBody`ã€`setHeader`ï¼‰ï¼Œè€Œä¸æ˜¯å¡è¿›ä¸€ä¸ªå¤§å†…æ ¸ã€‚
3. **è·¯ç”±åŸºäº radix3**ï¼šè·¯ç”±åŒ¹é…ç”¨ [unjs/radix3](https://radix3.unjs.io)ï¼Œæ”¯æŒè·¯å¾„å‚æ•°ã€é€šé…ç¬¦ã€åµŒå¥—è·¯ç”±ï¼ŒåŒ¹é…å¿«ä¸”è¯­ä¹‰æ¸…æ™°ã€‚
4. **ç±»å‹å‹å¥½**ï¼šå…¨ TypeScript ç¼–å†™ï¼Œ`defineEventHandler`ã€Eventã€å·¥å…·å‡½æ•°éƒ½æœ‰å®Œæ•´ç±»å‹ï¼Œåˆ©äºç»´æŠ¤å’Œé‡æ„ã€‚
5. **å“åº”å³ã€Œreturnã€**ï¼šåœ¨ handler é‡Œç›´æ¥ `return` å­—ç¬¦ä¸²ã€JSON å¯¹è±¡ã€Streamã€Web Response ç­‰ï¼Œh3 è‡ªåŠ¨è½¬æˆ HTTP å“åº”ï¼Œæ— éœ€æ‰‹å†™ `res.send()`ã€‚

ä¸€å¥è¯ï¼š**h3 = è½»é‡ã€å¯ç»„åˆçš„ã€ŒHTTP å¤„ç†å±‚ã€**ï¼šä½ å†™ã€Œäº‹ä»¶å¤„ç†å™¨ + å·¥å…·å‡½æ•°ã€ï¼Œh3 è´Ÿè´£æŠŠè¯·æ±‚äº¤ç»™ä½ ã€æŠŠä½ çš„è¿”å›å€¼å˜æˆå“åº”ï¼›Nuxt æœåŠ¡ç«¯ã€Nitro ç­‰éƒ½åœ¨ç”¨ h3ã€‚

---

## åŸç†ï¼šä¸ºä»€ä¹ˆè½»é‡ã€å¯ç»„åˆã€è·¨è¿è¡Œæ—¶

### 1. æ ¸å¿ƒåªæœ‰ã€ŒApp + Stackã€

- **App**ï¼šç”± `createApp()` åˆ›å»ºï¼Œæ˜¯ã€Œè¯·æ±‚å…¥å£ã€ã€‚
- **Stack**ï¼šä¸€ç»„ã€Œè·¯ç”±å‰ç¼€ + å¤„ç†å‡½æ•°ã€çš„æœ‰åºåˆ—è¡¨ï¼›æ¯ä¸ªè¯·æ±‚è¿›æ¥ï¼ŒæŒ‰é¡ºåºåŒ¹é…å‰ç¼€ï¼Œå‘½ä¸­åˆ™æ‰§è¡Œå¯¹åº” handlerï¼Œ**ç›´åˆ°æŸä¸ª handler è¿”å›äº†é undefined çš„å€¼**ï¼Œè¯¥å€¼è¢«å½“ä½œå“åº”å‘å‡ºã€‚
- ä¸è¿”å›çš„ handler ç›¸å½“äºã€Œä¸­é—´ä»¶ã€ï¼šåªåšå‰¯ä½œç”¨ï¼ˆå¦‚æ‰“æ—¥å¿—ã€æ”¹ `event.context`ï¼‰ï¼Œç„¶åäº¤ç»™ä¸‹ä¸€ä¸ªï¼›è‹¥å…¨éƒ¨éƒ½ä¸è¿”å›ï¼Œæœ€ç»ˆä¼š 404ã€‚

è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š**æ²¡æœ‰å†…ç½®çš„ã€Œè·¯ç”±è¡¨ã€ã€Œä¸­é—´ä»¶ç³»ç»Ÿã€ä¸¤å¥—æ¦‚å¿µ**ï¼Œè·¯ç”±å’Œã€Œä¸­é—´ä»¶ã€æœ¬è´¨éƒ½æ˜¯ã€Œå¸¦åŒ¹é…æ¡ä»¶çš„ handlerã€ï¼Œé€»è¾‘ç»Ÿä¸€ã€æ˜“æ¨ç†ã€‚

### 2. è¯·æ±‚/å“åº”æŠ½è±¡æˆ Event

- æ¯ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ª **H3Event**ï¼ˆç®€ç§° `event`ï¼‰ã€‚
- `event` ä¸ŠæŒ‚è½½ï¼š**å½’ä¸€åŒ–åçš„ methodã€pathã€headers**ï¼Œä»¥åŠ **è¿è¡Œæ—¶åŸç”Ÿå¯¹è±¡**ï¼ˆNode ä¸‹æ˜¯ `event.node.req/res`ï¼ŒWeb ä¸‹æ˜¯ `event.web.request`ï¼‰ã€‚
- é€šè¿‡ **é€‚é…å™¨**ï¼ŒæŠŠå„è¿è¡Œæ—¶çš„ã€Œè¯·æ±‚ã€è½¬æˆç»Ÿä¸€çš„ `event`ï¼Œå†æŠŠ handler çš„ã€Œè¿”å›å€¼ã€è½¬æˆå„è¿è¡Œæ—¶çš„ã€Œå“åº”ã€ã€‚å› æ­¤ä¸šåŠ¡ä»£ç åªä¾èµ– `event` å’Œå·¥å…·å‡½æ•°ï¼Œä¸ç›´æ¥ç¢° `req/res`ï¼Œæ¢è¿è¡Œæ—¶åªéœ€æ¢é€‚é…å™¨ã€‚

### 3. åŠŸèƒ½ç”¨ã€Œå·¥å…·å‡½æ•°ã€è€Œä¸æ˜¯ã€Œå†…ç½® API è†¨èƒ€ã€

- è¯» queryã€bodyã€headerã€è·¯ç”±å‚æ•°ç­‰ï¼Œéƒ½æ˜¯ **ä» h3 åŒ… import çš„çº¯å‡½æ•°**ï¼Œä¾‹å¦‚ `getQuery(event)`ã€`readBody(event)`ã€‚
- è¿™æ ·åšçš„æ•ˆæœï¼š**Tree-shakable**â€”â€”åª import ç”¨åˆ°çš„ï¼Œæ‰“åŒ…ä½“ç§¯å°ï¼›**å¯æµ‹**â€”â€”å•æµ‹æ—¶é€ ä¸€ä¸ª `event` å³å¯ï¼›**å¯æ›¿æ¢**â€”â€”ä½ å®Œå…¨å¯ä»¥è‡ªå·±å†™ä¸€ä¸ª `readBody` æ›¿ä»£å®ç°ã€‚

### 4. è·¯ç”±ï¼šradix3 åšåŒ¹é…

- Router å†…éƒ¨ç”¨ radix tree åšè·¯å¾„åŒ¹é…ï¼Œæ”¯æŒ `:param`ã€`*`ã€`**` ç­‰ï¼Œä¸€æ¬¡åŒ¹é…å³å¯å¾—åˆ° paramsï¼Œæ— éœ€è‡ªå·±ç”¨æ­£åˆ™æˆ–å­—ç¬¦ä¸²åˆ‡å‰²ã€‚

å¯ä»¥ç®€å•è®°ï¼š**App+Stack ç»Ÿä¸€è·¯ç”±ä¸ä¸­é—´ä»¶ â†’ Event ç»Ÿä¸€è¯·æ±‚æŠ½è±¡ â†’ é€‚é…å™¨ç»Ÿä¸€å¤šè¿è¡Œæ—¶ â†’ å·¥å…·å‡½æ•°æŒ‰éœ€ç»„åˆ = è½»é‡ä¸”å¯ç§»æ¤**ã€‚

---

## ä¸ Expressã€Fastify çš„å¯¹æ¯”

| å¯¹æ¯”é¡¹       | h3                    | Express           | Fastify              |
|--------------|------------------------|-------------------|----------------------|
| **å®šä½**     | è½»é‡ã€å¯ç»„åˆã€è·¨è¿è¡Œæ—¶ | ä¼ ç»Ÿ Node Web æ¡†æ¶ | é«˜æ€§èƒ½ Node æ¡†æ¶      |
| **è¿è¡Œæ—¶**   | Node / Bun / Deno / Workers | ä¸»è¦ Node         | ä¸»è¦ Node            |
| **è·¯ç”±**     | radix3ï¼Œæ”¯æŒåµŒå¥—      | å†…ç½® Router       | å†…ç½®ï¼Œæ’ä»¶ç”Ÿæ€        |
| **è¯·æ±‚/å“åº”**| Event + return        | req / res         | request / reply      |
| **ä¸­é—´ä»¶**   | ä¸ return çš„ handler  | app.use ä¸­é—´ä»¶    | æ’ä»¶ / é’©å­          |
| **ç±»å‹**     | å…¨ TSï¼Œç±»å‹å®Œå–„       | éœ€ @types/express | åŸç”Ÿ TS å‹å¥½          |
| **ä½“ç§¯/å¤æ‚åº¦** | å°ï¼Œå¯ç»„åˆ          | ç”Ÿæ€å¤§ã€æ¦‚å¿µå¤š    | ä¸­ç­‰ï¼Œåæ€§èƒ½          |
| **å…¸å‹ç”¨é€”** | Nuxt/Nitroã€è¾¹ç¼˜/å¤šç«¯ | ä¼ ç»Ÿ Node æœåŠ¡    | é«˜æ€§èƒ½ APIã€Node æœåŠ¡ |

**ç®€å•è®°**ï¼š  
- **è¦è·¨è¿è¡Œæ—¶ã€æˆ–ç»™ Nuxt/Nitro å†™é€»è¾‘** â†’ ç”¨ **h3**ã€‚  
- **åªåœ¨ Nodeã€è¦ç”Ÿæ€å’Œèµ„æ–™å¤š** â†’ **Express**ã€‚  
- **åªåœ¨ Nodeã€è¦æè‡´æ€§èƒ½** â†’ **Fastify**ã€‚

---

## å®‰è£…ä¸ä½¿ç”¨æ–¹å¼

### å®‰è£…

```bash
pnpm add h3
# æˆ–
npm i h3
```

### æœ€ç®€ç¤ºä¾‹ï¼ˆNode æœ¬åœ°è·‘ï¼‰

**app.mjs**ï¼ˆæˆ– app.tsï¼‰ï¼š

```js
import { createApp, createRouter, defineEventHandler } from "h3";

export const app = createApp();

const router = createRouter();
router.get("/", defineEventHandler(() => ({ message: "âš¡ï¸ Tadaa!" })));
app.use(router);
```

**server.mjs**ï¼ˆNode å…¥å£ï¼‰ï¼š

```js
import { createServer } from "node:http";
import { toNodeListener } from "h3";
import { app } from "./app.mjs";

createServer(toNodeListener(app)).listen(process.env.PORT || 3000);
```

è¿è¡Œï¼š`node server.mjs`ï¼Œè®¿é—® `http://localhost:3000/` ä¼šå¾—åˆ° JSON `{ "message": "âš¡ï¸ Tadaa!" }`ã€‚

### ç”¨ listhen é›¶é…ç½®èµ·æœåŠ¡ï¼ˆæ¨èå¼€å‘æ—¶ï¼‰

åªéœ€å¯¼å‡º `app`ï¼Œç”¨ [unjs/listhen](https://listhen.unjs.io) èµ·æœåŠ¡ï¼ˆè‡ªåŠ¨æ”¯æŒ TSã€çƒ­æ›´æ–°ç­‰ï¼‰ï¼š

```bash
npx --yes listhen --watch --open ./app.ts
```

---

## App å®ä¾‹ä¸å…¨å±€é’©å­

### åˆ›å»º App

```js
import { createApp } from "h3";

const app = createApp();
```

å¯é€‰ä¼ å…¥ **å…¨å±€é…ç½®**ï¼š

```js
const app = createApp({
  debug: true,
  onError(err) {
    console.error(err);
  },
  onRequest(event) {
    console.log("Request:", event.path);
  },
  onBeforeResponse(event) { /* ... */ },
  onAfterResponse(event) { /* ... */ },
});
```

- **onError**ï¼šä»»æ„ handler æˆ–é’©å­é‡ŒæŠ›é”™æ—¶è°ƒç”¨ã€‚  
- **onRequest**ï¼šæ¯æ¬¡è¯·æ±‚è¿›æ¥æ—¶ã€‚  
- **onBeforeResponse**ï¼šåœ¨çœŸæ­£æŠŠå“åº”å‘å‡ºå»ä¹‹å‰ã€‚  
- **onAfterResponse**ï¼šå“åº”å‘å‡ºä¹‹åã€‚

### æ³¨å†Œ Handlerï¼ˆapp.useï¼‰

```js
import { defineEventHandler } from "h3";

app.use("/hello", defineEventHandler((event) => "Hello world!"));
```

- ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ **è·¯å¾„å‰ç¼€**ï¼šè¯·æ±‚ path ä»¥æ­¤å‰ç¼€å¼€å¤´å°±ä¼šè¿›è¿™ä¸ª handlerï¼ˆå¦‚ `/hello`ã€`/hello/xxx` éƒ½ä¼šå‘½ä¸­ï¼‰ã€‚
- ç¬¬äºŒä¸ªå‚æ•°æ˜¯ **äº‹ä»¶å¤„ç†å™¨**ï¼ˆè§ä¸‹èŠ‚ï¼‰ã€‚
- å¤šä¸ª `app.use` æŒ‰æ³¨å†Œé¡ºåºç»„æˆã€Œæ ˆã€ï¼šå…ˆæ³¨å†Œçš„å…ˆæ‰§è¡Œï¼Œä¸€æ—¦æŸä¸ª handler **æœ‰ return å€¼**ï¼Œå°±æŠŠå®ƒå½“å“åº”è¿”å›ï¼Œåé¢çš„ä¸å†æ‰§è¡Œï¼›è‹¥ä¸€ç›´æ²¡äºº returnï¼Œæœ€å 404ã€‚

### å¯é€‰ï¼šmatcherã€lazy

ç¬¬ä¸‰å‚æ•°å¯ä¼  **options**ï¼š

- **matcher(url)**ï¼šè‡ªå®šä¹‰ã€Œæ˜¯å¦å‘½ä¸­ã€çš„é€»è¾‘ï¼ˆåªåšç®€å•è¿‡æ»¤ï¼Œå¤æ‚è·¯ç”±å»ºè®®ç”¨ Routerï¼‰ã€‚
- **lazy: true**ï¼šç¬¬ä¸€æ¬¡å‘½ä¸­è¯¥è·¯ç”±æ—¶æ‰å»åŠ è½½ handlerï¼ˆä¾‹å¦‚ `() => import('./big-handler')`ï¼‰ï¼Œé€‚åˆå‡å°‘å¯åŠ¨æ—¶åŠ è½½é‡ã€‚

---

## äº‹ä»¶å¤„ç†å™¨ä¸å“åº”ç±»å‹

### å®šä¹‰äº‹ä»¶å¤„ç†å™¨

ç”¨ `defineEventHandler` æˆ– `eventHandler`ï¼ˆä¸¤è€…ç­‰ä»·ï¼‰ï¼š

```js
import { defineEventHandler } from "h3";

defineEventHandler((event) => {
  return "Response";
});
```

å›è°ƒå¯ä»¥æ˜¯ **åŒæ­¥** æˆ– **å¼‚æ­¥**ï¼›**è¿”å›å€¼** å³å“åº”å†…å®¹ï¼Œh3 ä¼šè‡ªåŠ¨è½¬æ¢ï¼š

| è¿”å›å€¼ç±»å‹ | è¡Œä¸º |
|------------|------|
| æ™®é€šå¯¹è±¡ï¼ˆå¯ JSON åºåˆ—åŒ–ï¼‰ | åºåˆ—åŒ–ä¸º JSONï¼Œ`Content-Type: application/json` |
| `string` | åŸæ ·è¾“å‡ºï¼Œé»˜è®¤ `text/html` |
| `null` | 204 No Content |
| `ReadableStream` / Node `Readable` | æµå¼å“åº” |
| `ArrayBuffer` / Node `Buffer` | äºŒè¿›åˆ¶å“åº” |
| Web `Response` | ç›´æ¥ä½œä¸ºå“åº” |
| `Error`ï¼ˆå»ºè®®ç”¨ `createError`ï¼‰ | è½¬æˆé”™è¯¯å“åº” |
| `Promise<ä¸Šè¿°ä»»ä¸€>` | ç­‰ resolve åå†å‘å“åº” |

æ‰€ä»¥ä½ å¯ä»¥ç›´æ¥ï¼š

```js
app.use("/api", defineEventHandler(async (event) => ({ url: event.node.req.url })));
```

### é”™è¯¯å¤„ç†ï¼šcreateError

å»ºè®®ç”¨ `createError` æŠ›ä¸šåŠ¡é”™è¯¯ï¼Œä¾¿äºç»Ÿä¸€çŠ¶æ€ç å’Œæ¶ˆæ¯ï¼š

```js
import { createError, defineEventHandler } from "h3";

app.use("/validate", defineEventHandler((event) => {
  throw createError({
    status: 400,
    statusMessage: "Bad Request",
    message: "Invalid user input",
    data: { field: "email" },
  });
}));
```

- **status**ï¼šHTTP çŠ¶æ€ç ã€‚  
- **statusMessage**ï¼šçŠ¶æ€è¡Œæ–‡å­—ï¼ˆå¦‚ "Bad Request"ï¼‰ï¼Œä¼šå‡ºç°åœ¨ HTTP å“åº”é‡Œã€‚  
- **message**ï¼šé”™è¯¯è¯´æ˜ï¼ˆæœåŠ¡ç«¯ç”¨ï¼›è‹¥ä¸ç»ç‰¹æ®Šå¤„ç†ï¼Œä¸ä¼šç›´æ¥æš´éœ²ç»™å®¢æˆ·ç«¯ï¼Œå¯ç”¨ `data` ä¼ ç»“æ„åŒ–ä¿¡æ¯ï¼‰ã€‚  
- è‹¥åªä¼ å­—ç¬¦ä¸²ï¼š`throw createError("å‡ºé”™")`ï¼Œé»˜è®¤ status 500ã€‚

æœªç”¨ `createError` è€Œç›´æ¥ `throw new Error()`ï¼Œh3 ä¼šå½“ä½œ 500 å¤„ç†ã€‚

### æ‡’åŠ è½½ Handlerï¼šdefineLazyEventHandler

é€‚åˆã€Œç¬¬ä¸€æ¬¡å‘½ä¸­è¯¥è·¯ç”±æ—¶æ‰æ‰§è¡Œåˆå§‹åŒ–ã€å†è¿”å›çœŸæ­£çš„ handlerã€ï¼š

```js
import { defineLazyEventHandler, defineEventHandler } from "h3";

app.use(defineLazyEventHandler(() => {
  console.log("åªæ‰§è¡Œä¸€æ¬¡");
  return defineEventHandler((event) => "Response");
}));
```

### ä¸­é—´ä»¶ï¼ˆä¸ return çš„ handlerï¼‰

ä¸ return çš„ handler ç›¸å½“äºä¸­é—´ä»¶ï¼šåªåšå‰¯ä½œç”¨ï¼Œç„¶åäº¤ç»™ä¸‹ä¸€ä¸ªï¼š

```js
app.use(defineEventHandler((event) => {
  console.log("Middleware:", event.path);
}));
app.use(defineEventHandler((event) => "Response"));
```

å®˜æ–¹æ›´æ¨èç”¨ **å¯¹è±¡è¯­æ³•çš„ hooks**ï¼ˆonRequest / onBeforeResponse ç­‰ï¼‰å’Œ **ç»„åˆå¼å·¥å…·** ä»£æ›¿å…¨å±€ä¸­é—´ä»¶ï¼Œä¾¿äºè¿½è¸ªå’Œ Tree-shakeã€‚

---

## è·¯ç”±ï¼šRouter ä¸ radix3

`app.use` åªåšã€Œè·¯å¾„å‰ç¼€ã€åŒ¹é…ï¼›è¦åš **æŒ‰ HTTP æ–¹æ³• + è·¯å¾„å‚æ•°** çš„è·¯ç”±ï¼Œç”¨ **Router**ï¼ˆå†…éƒ¨ç”¨ radix3ï¼‰ã€‚

### åŸºæœ¬ç”¨æ³•

```js
import { createApp, createRouter, defineEventHandler } from "h3";

const app = createApp();
const router = createRouter();
app.use(router);

router.get("/hello", defineEventHandler(() => "Hello world!"));
router.post("/hello", defineEventHandler(() => "POST Hello!"));
```

- `router.get/post/put/delete/...` æ³¨å†Œå¯¹åº”æ–¹æ³•çš„è·¯ç”±ã€‚  
- `router.use(path, handler)` æ³¨å†Œã€Œä»»æ„æ–¹æ³•éƒ½å‘½ä¸­ã€çš„ handlerã€‚

### è·¯å¾„å‚æ•°

ç”¨ `:name` è¡¨ç¤ºè·¯å¾„å‚æ•°ï¼Œåœ¨ `event.context.params` é‡Œå–ï¼š

```js
router.get("/hello/:name", defineEventHandler((event) => {
  return `Hello ${event.context.params.name}!`;
}));
```

è¯·æ±‚ `/hello/world` ä¼šå¾—åˆ° `Hello world!`ã€‚

### é€šé…ç¬¦

- `*`ï¼šåŒ¹é…ä¸€æ®µè·¯å¾„ï¼Œå†…å®¹åœ¨ `event.context.params._`ã€‚  
- `**`ï¼šåŒ¹é…å¤šæ®µè·¯å¾„ï¼Œæ•´æ®µåœ¨ `event.context.params._`ã€‚

ä¾‹å¦‚ï¼š

- `/hello/*` åŒ¹é… `/hello`ã€`/hello/a`ï¼Œä¸åŒ¹é… `/hello/a/b`ã€‚  
- `/hello/**` åŒ¹é… `/hello`ã€`/hello/a`ã€`/hello/a/b`ã€‚

### åµŒå¥—è·¯ç”±

å¯ä»¥æŠŠå­è·¯ç”±æŒ‚åˆ°ä¸»è·¯ç”±ä¸‹ï¼Œç”¨ `useBase` ç»Ÿä¸€åŠ å‰ç¼€ï¼š

```js
import { createRouter, defineEventHandler, useBase } from "h3";

const apiRouter = createRouter()
  .get("/hello", defineEventHandler(() => "Hello API!"));

const websiteRouter = createRouter()
  .get("/", defineEventHandler(() => "Hello world!"))
  .use("/api/**", useBase("/api", apiRouter.handler));

app.use(websiteRouter);
```

è¿™æ · `/api/hello` ä¼šç”± `apiRouter` å¤„ç†ã€‚æ³¨æ„è¦ä¼  `apiRouter.handler`ï¼Œå¹¶ç”¨ `/**` ä¿è¯å­è·¯å¾„éƒ½äº¤ç»™ apiRouterã€‚

---

## Event å¯¹è±¡ä¸è¯·æ±‚å·¥å…·

æ¯ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ª **H3Event**ï¼Œåœ¨ handler é‡Œä»¥ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ï¼ˆå¸¸å†™ä½œ `event`ï¼‰ã€‚

### Event å¸¸ç”¨å±æ€§

- **event.method**ï¼šå½’ä¸€åŒ–åçš„ HTTP æ–¹æ³•ï¼ˆå¤§å†™ï¼‰ã€‚  
- **event.path**ï¼šè¯·æ±‚è·¯å¾„ï¼ˆå« query éƒ¨åˆ†ï¼Œå¦‚ `/test?a=1`ï¼‰ã€‚  
- **event.headers**ï¼šå½’ä¸€åŒ–åçš„è¯·æ±‚å¤´ï¼ˆWeb Headers æˆ–å…¼å®¹ç»“æ„ï¼‰ã€‚  
- **event.context**ï¼šå¯éšæ„æŒ‚æ•°æ®çš„å¯¹è±¡ï¼Œåœ¨åŒä¸€æ¬¡è¯·æ±‚çš„å„ä¸ª handler/å·¥å…·é—´å…±äº«ã€‚  
- **event.node**ï¼šNode ä¸‹ä¸º `{ req, res }`ï¼Œé Node æ—¶ç”± h3 ç”¨å…¼å®¹å±‚æ¨¡æ‹Ÿã€‚  
- **event.web**ï¼šåœ¨æ”¯æŒ Web æ ‡å‡†çš„ç¯å¢ƒä¸‹æœ‰ `request`ã€`url` ç­‰ã€‚  
- **event.handled**ï¼šæ˜¯å¦å·²å‘é€å“åº”ï¼›è‹¥ä½ è‡ªå·±è°ƒäº† `event.respondWith` ç­‰ï¼Œå¯è®¾ä¸º `true` é¿å… h3 å†å‘ä¸€æ¬¡ã€‚

### è¯·æ±‚ç›¸å…³å·¥å…·ï¼ˆRequest Utilsï¼‰

ä» `h3` æŒ‰éœ€ importï¼Œéƒ½æ¥æ”¶ `event` ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼š

- **getQuery(event)**ï¼šè§£æ URL queryï¼Œè¿”å›å¯¹è±¡ï¼ˆæ”¯æŒæ•°ç»„å€¼ï¼‰ã€‚  
- **getRouterParam(event, name)** / **getRouterParams(event)**ï¼šè·¯ç”±å‚æ•°ã€‚  
- **getHeader(event, name)** / **getHeaders(event)**ï¼šè¯·æ±‚å¤´ã€‚  
- **getRequestURL(event)**ã€**getRequestHost(event)**ã€**getRequestIP(event)**ã€**getRequestProtocol(event)**ï¼šURLã€Hostã€IPã€åè®®ã€‚  
- **readBody(event)**ï¼šè¯»å– body å¹¶å°è¯•ç”¨ [destr](https://github.com/unjs/destr) è§£æï¼ˆJSON ç­‰ï¼‰ï¼›æ³¨æ„ä¼šè§£æ form ç­‰ï¼Œæ•æ„Ÿæ“ä½œå»ºè®®æ ¡éªŒ Content-Typeã€‚  
- **readRawBody(event, encoding)**ï¼šåŸå§‹ body å­—ç¬¦ä¸²æˆ– Bufferã€‚  
- **readFormData(event)**ï¼šè¡¨å•ï¼Œå¾—åˆ° Web FormDataã€‚  
- **readMultipartFormData(event)**ï¼šmultipart è¡¨å•ã€‚  
- **isMethod(event, method)**ï¼šæ˜¯å¦æ˜¯æŒ‡å®šæ–¹æ³•ï¼›**assertMethod(event, method)**ï¼šä¸æ˜¯åˆ™æŠ› 405ã€‚  
- **getValidatedQuery(event, validate)** / **readValidatedBody(event, validate)**ï¼šè¯»å®Œåç”¨æ ¡éªŒå‡½æ•°æˆ– zod ç­‰åšæ ¡éªŒï¼Œä¸é€šè¿‡ä¼šæŠ›é”™ã€‚

ç¤ºä¾‹ï¼š

```js
import { defineEventHandler, getQuery, readBody, getRouterParam } from "h3";

export default defineEventHandler(async (event) => {
  const query = getQuery(event);
  const id = getRouterParam(event, "id");
  const body = await readBody(event).catch(() => ({}));
  return { path: event.path, method: event.method, query, id, body };
});
```

### å“åº”ç›¸å…³ï¼ˆResponse Utilsï¼‰

- **setHeader(event, name, value)** / **setHeaders(event, headers)**  
- **setResponseStatus(event, status)** / **setResponseStatusMessage(event, message)**  
- **sendRedirect(event, location, code)**  
- **sendStream(event, stream)**  
- **send(event, data, type?)**  
- **sendNoContent(event)**  

å¤šæ•°åœºæ™¯ç›´æ¥ **return å€¼** å³å¯ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶å¤´æˆ–çŠ¶æ€ç æ—¶å†ç”¨è¿™äº›ã€‚

---

## é€‚é…å™¨ï¼šNode / Web / å…¶ä»–è¿è¡Œæ—¶

h3 çš„ã€Œåº”ç”¨ã€æ˜¯è¿è¡Œæ—¶æ— å…³çš„ï¼›çœŸæ­£å’Œè¿è¡Œæ—¶æ‰“äº¤é“çš„æ˜¯ **é€‚é…å™¨**ã€‚

### Node.jsï¼štoNodeListener

æŠŠ app è½¬æˆ Node çš„ `(req, res) => void`ï¼Œäº¤ç»™ `http.createServer`ï¼š

```js
import { createServer } from "node:http";
import { toNodeListener } from "h3";
import { app } from "./app.mjs";

createServer(toNodeListener(app)).listen(process.env.PORT || 3000);
```

### Web æ ‡å‡†ï¼ˆDeno / Workers ç­‰ï¼‰ï¼štoWebHandler

æŠŠ app è½¬æˆ `(request: Request) => Promise<Response>`ï¼Œç”¨äº Denoã€Cloudflare Workersã€Vercel ç­‰ï¼š

```js
import { toWebHandler } from "h3";
import { app } from "./app.mjs";

export const handler = toWebHandler(app);
```

### ä» Node/Web è½¬æˆ h3 Handler

- **fromNodeListener(nodeHandler)**ï¼šå·²æœ‰çš„ `(req, res) => void` è½¬æˆ h3 çš„ event handlerï¼Œå¯å† `app.use(fromNodeListener(expressMiddleware))` ç­‰ã€‚  
- **fromWebHandler(webHandler)**ï¼šå·²æœ‰çš„ `(Request) => Response | Promise<Response>` è½¬æˆ h3 handlerã€‚

è¿™æ ·æ—¢èƒ½åœ¨ h3 é‡Œå¤ç”¨æ—§ä¸­é—´ä»¶ï¼Œä¹Ÿèƒ½æŠŠ h3 app æ¥åˆ°å„ç§è¾¹ç¼˜/Serverless ç¯å¢ƒã€‚

---

## å¸¸è§åœºæ™¯ä¸æœ€ä½³å®è·µ

### 1. å¥åº·æ£€æŸ¥æ¥å£

```js
router.get("/health", defineEventHandler(() => ({ ok: true })));
```

### 2. å¸¦æ ¡éªŒçš„ POSTï¼ˆç”¨ zodï¼‰

```js
import { defineEventHandler, readValidatedBody } from "h3";
import { z } from "zod";

const bodySchema = z.object({ name: z.string(), age: z.number().optional() });

export default defineEventHandler(async (event) => {
  const body = await readValidatedBody(event, bodySchema.parse);
  return { received: body };
});
```

### 3. å…¨å±€é”™è¯¯ä¸æ—¥å¿—

åœ¨ `createApp({ onError, onRequest })` é‡Œç»Ÿä¸€æ‰“æ—¥å¿—ã€æ ¼å¼åŒ–é”™è¯¯å“åº”ã€‚  
ä¸šåŠ¡é‡Œç”¨ `createError` æŠ›é”™ï¼Œé¿å…ç›´æ¥ `throw new Error()`ã€‚

### 4. è·¨åŸŸï¼ˆCORSï¼‰

åœ¨ `onRequest` æˆ–ç¬¬ä¸€ä¸ª handler é‡Œç”¨ `setResponseHeaders` è®¾ç½® CORS å¤´ï¼›æˆ–ä½¿ç”¨ç¤¾åŒº CORS å·¥å…·ï¼ˆè‹¥åŸºäº h3 çš„ event å®ç°ï¼‰ã€‚

### 5. å°‘ç”¨ã€Œä¸ return çš„ä¸­é—´ä»¶ã€

ä¼˜å…ˆç”¨ **å¯¹è±¡è¯­æ³•çš„ onRequest/onBeforeResponse** å’Œ **ç»„åˆå¼å·¥å…·**ï¼Œé€»è¾‘æ›´æ¸…æ™°ã€ä¹Ÿåˆ©äº Tree-shakeã€‚

### 6. å¤§ handler æ‡’åŠ è½½

å¯¹å¾ˆå°‘è§¦è¾¾çš„è·¯ç”±ç”¨ `defineLazyEventHandler` æˆ– `app.use(path, () => import("./handler"), { lazy: true })`ï¼Œå‡å°é¦–å¯æ—¶é—´ã€‚

---

## å‚è€ƒä¸å»¶ä¼¸é˜…è¯»

- [h3 å®˜æ–¹æ–‡æ¡£](https://h3.unjs.io/)  
- [h3 Guide](https://h3.unjs.io/guide)ï¼ˆGetting Started / App / Event Handler / Router / Event ç­‰ï¼‰  
- [h3 Utils](https://h3.unjs.io/utils)ï¼ˆRequest / Response ç­‰ï¼‰  
- [h3 Adapters](https://h3.unjs.io/adapters)ï¼ˆNode / Web ç­‰ï¼‰  
- [unjs/radix3](https://radix3.unjs.io)ï¼ˆè·¯ç”±åŒ¹é…ï¼‰  
- [unjs/listhen](https://listhen.unjs.io)ï¼ˆé›¶é…ç½®èµ· h3 æœåŠ¡ï¼‰  
- [Nitro](https://nitro.unjs.io)ï¼ˆåŸºäº h3 çš„æœåŠ¡å™¨å·¥å…·åŒ…ï¼ŒNuxt æœåŠ¡ç«¯åº•å±‚ï¼‰

---

**å°ç»“**ï¼šh3 ç”¨ã€ŒApp + äº‹ä»¶å¤„ç†å™¨æ ˆ + Eventã€ç»Ÿä¸€è¯·æ±‚/å“åº”ä¸å¤šè¿è¡Œæ—¶ï¼Œç”¨ã€Œå·¥å…·å‡½æ•°ã€å’Œã€ŒRouter(radix3)ã€ä¿æŒè½»é‡å’Œå¯ç»„åˆï¼›å†™æ¥å£æ—¶ä»¥ `defineEventHandler` + `return` ä¸ºä¸»ï¼ŒæŒ‰éœ€ç”¨ `getQuery`ã€`readBody`ã€`createError` ç­‰ï¼Œå³å¯å¿«é€Ÿã€æ¸…æ™°åœ°æŠŠ HTTP API å†™èµ·æ¥ã€‚
